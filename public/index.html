<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Autumn Minimal Demo</title>
	<meta name="viewport"
				content="width=device-width, initial-scale=1" />
	<style>
		:root {
			color-scheme: light;
			font-synthesis-weight: none;
		}

		body {
			font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
			margin: 0;
			padding: 24px;
		}

		.card {
			max-width: 520px;
			margin: 0 auto;
			border: 1px solid #e5e5e5;
			border-radius: 12px;
			padding: 24px;
			box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
		}

		h1 {
			font-size: 22px;
			margin: 0 0 8px;
		}

		p {
			margin: 0 0 12px;
			color: #333;
		}

		.row {
			display: flex;
			align-items: center;
			gap: 12px;
			flex-wrap: wrap;
		}

		button {
			padding: 10px 14px;
			border-radius: 10px;
			border: 1px solid #ddd;
			background: #fff;
			cursor: pointer;
		}

		button:hover {
			background: #f6f6f6;
		}

		.joke {
			margin-top: 16px;
			padding: 12px;
			background: #fafafa;
			border: 1px dashed #ddd;
			border-radius: 8px;
			min-height: 20px;
		}

		.upgrade {
			margin-top: 12px;
		}

		.badge {
			padding: 4px 10px;
			border-radius: 999px;
			border: 1px solid #ddd;
			background: #f9f9f9;
			font-size: 12px;
		}

		.small {
			color: #666;
			font-size: 12px;
		}
	</style>
</head>

<body>
	<div class="card">
		<h1>AI Joke (credits demo)</h1>
		<p class="small">Consumes 1 credit via Autumn. Shows remaining credits.</p>

		<div class="row"
				 style="margin-bottom:8px">
			<button id="btn">Tell me a joke</button>
			<span class="badge"
						id="credits">Credits: â€¦</span>
			<button id="refresh">â†» Refresh</button>
		</div>

		<div id="out"
				 class="joke"></div>

		<div id="upgrade"
				 class="upgrade"
				 hidden>
			<p>Youâ€™re out of credits.</p>
			<button id="upgradeBtn">Upgrade</button>
		</div>
	</div>
	<!-- Add inside <body> after your existing controls -->
	<div class="card"
			 style="margin-top:16px">
		<h2 style="font-size:18px;margin:0 0 8px">Buy credits</h2>
		<div class="row"
				 style="margin-bottom:8px">
			<select id="pack"></select>
			<button id="buy">Buy credits</button>
		</div>
		<p class="small">After payment, youâ€™ll be sent back here. Weâ€™ll refresh your balance
			automatically.</p>
	</div>

	<script>
		const packSel = document.getElementById("pack");
		const buyBtn = document.getElementById("buy");

		async function loadPacks() {
			try {
				const r = await fetch("/api/topup/options");
				const d = await r.json();
				packSel.innerHTML = "";
				(d.options || []).forEach(o => {
					const opt = document.createElement("option");
					opt.value = o.key;
					opt.textContent = `${o.label} (${o.credits} credits)`;
					packSel.appendChild(opt);
				});
				buyBtn.disabled = !(d.options || []).length;
			} catch {
				packSel.innerHTML = "<option>Unavailable</option>";
				buyBtn.disabled = true;
			}
		}
		buyBtn.addEventListener("click", async () => {
			const pack = packSel.value;
			buyBtn.disabled = true;
			try {
				const r = await fetch(`/api/topup/checkout?pack=${encodeURIComponent(pack)}`, { method: "POST" });
				const d = await r.json();
				if (d?.url) {
					window.location.href = d.url; // go to Stripe Checkout (via Autumn)
				} else {
					alert(d?.message || "Could not start checkout");
				}
			} finally {
				buyBtn.disabled = false;
			}
		});

		// If we came back from a successful checkout, refresh credits
		const q = new URLSearchParams(location.search);
		if (q.get("topup") === "success") {
			// tiny delay to give Autumn time to post-process
			setTimeout(() => {
				if (typeof loadCredits === "function") loadCredits();
			}, 1000);
		}

		// initialize
		loadPacks();

		const btn = document.getElementById("btn");
		const out = document.getElementById("out");
		const upgrade = document.getElementById("upgrade");
		const upgradeBtn = document.getElementById("upgradeBtn");
		const creditsEl = document.getElementById("credits");
		const refreshBtn = document.getElementById("refresh");

		let lastCheckoutUrl = null;

		async function loadCredits() {
			try {
				const res = await fetch("/api/credits");
				const data = await res.json();
				const val = (typeof data?.remaining === "number") ? data.remaining : " ?";
				creditsEl.textContent = "Credits: " + val;
			} catch {
				creditsEl.textContent = "Credits: ?";
			}
		}

		refreshBtn.addEventListener("click", loadCredits);

		btn.addEventListener("click", async () => {
			out.textContent = "Thinkingâ€¦";
			upgrade.hidden = true;

			try {
				const res = await fetch("/api/joke");
				const data = await res.json();

				if (!res.ok) {
					if (data?.error === "upgrade_required" && data?.checkoutUrl) {
						lastCheckoutUrl = data.checkoutUrl;
						upgrade.hidden = false;
						out.textContent = "Youâ€™re out of credits.";
						creditsEl.textContent = "Credits: 0";
						return;
					}
					out.textContent = data?.message || "Something went wrong.";
					return;
				}

				out.textContent = data.joke || "No joke? ðŸ¤–";
				// Use the value returned by server if available; otherwise refetch.
				if (typeof data.remaining === "number") {
					creditsEl.textContent = "Credits: " + data.remaining;
				} else {
					await loadCredits();
				}
			} catch (e) {
				out.textContent = String(e);
			}
		});

		upgradeBtn.addEventListener("click", async () => {
			if (lastCheckoutUrl) {
				window.location.href = lastCheckoutUrl;
				return;
			}
			const res = await fetch("/api/checkout");
			const data = await res.json();
			if (data?.url) window.location.href = data.url;
		});

		// initial credits fetch
		loadCredits();
	</script>
</body>

</html>
